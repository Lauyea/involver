@page
@model Involver.Pages.Involvings.ArticleInvolversModel
@{
    ViewData["Title"] = "Involvers";
    Layout = "~/Pages/Shared/_Layout.cshtml";

    string titleSub = "最近（按時間排序）";
    string recentBtnClass = "active";
    string monthlyBtnClass = "";
    string totalTimeBtnClass = "";

    switch (Model.TimeSpan)
    {
        case "TotalTime":
            titleSub = "總共（按貢獻排序）";
            totalTimeBtnClass = "active";
            recentBtnClass = "";
            break;
        case "Monthly":
            titleSub = "每月（按貢獻排序）";
            monthlyBtnClass = "active";
            recentBtnClass = "";
            break;
    }
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">@ViewData["Title"] - @titleSub</h4>
        <div class="d-flex gap-2">
            <a asp-page="../Articles/Details" asp-route-id="@Model.ArticleID" class="btn btn-outline-secondary">
                <i class="fas fa-chevron-left"></i> 回到文章
            </a>
            <div class="dropdown">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    篩選 <i class="fas fa-filter"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item @recentBtnClass"
                       asp-page="./ArticleInvolvers"
                       asp-route-id="@Model.ArticleID"
                       title="Recent">最近</a>
                    <a class="dropdown-item @monthlyBtnClass"
                       asp-page="./ArticleInvolvers"
                       asp-route-id="@Model.ArticleID"
                       asp-route-TimeSpan="Monthly"
                       title="Monthly">每月</a>
                    <a class="dropdown-item @totalTimeBtnClass"
                       asp-page="./ArticleInvolvers"
                       asp-route-id="@Model.ArticleID"
                       asp-route-TimeSpan="TotalTime"
                       title="TotalTime">總共</a>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            @if (Model.Involvings != null && Model.Involvings.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table">
                            <tr>
                                <th scope="col">Involver</th>
                                <th scope="col" class="text-end">數量 (In幣)</th>
                                <th scope="col" class="text-end">時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (Involving involving in Model.Involvings)
                            {
                                <tr>
                                    <td>
                                        @if (involving.InvolverID != null)
                                        {
                                            <a asp-area="Identity"
                                               asp-page="/Profile/Index"
                                               asp-route-id="@involving.InvolverID"
                                               class="text-decoration-none d-flex align-items-center">
                                                @if (!string.IsNullOrEmpty(involving.Involver.ImageUrl))
                                                {
                                                    <img src="@involving.Involver.ImageUrl"
                                                         asp-append-version="true"
                                                         alt="Avatar"
                                                         class="rounded-circle me-2"
                                                         style="width: 40px; height: 40px; object-fit: cover;">
                                                }
                                                else
                                                {
                                                    var user = await userManager.FindByIdAsync(involving.Involver.ProfileID);
                                                    <img src="https://www.gravatar.com/avatar/@user.Email.ToMd5()?d=retro"
                                                         alt="Avatar"
                                                         class="rounded-circle me-2"
                                                         style="width: 40px; height: 40px; object-fit: cover;">
                                                }
                                                <span class="fw-bold">@Html.DisplayFor(modelItem => involving.Involver.UserName)</span>
                                            </a>
                                        }
                                        else
                                        {
                                            <span>匿名使用者</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @{
                                            var value = Model.TimeSpan == "TotalTime" ? involving.TotalValue
                                                      : Model.TimeSpan == "Monthly" ? involving.MonthlyValue
                                                      : involving.Value;
                                        }
                                        <span class="fw-bold">@value</span>
                                    </td>
                                    <td class="text-end" title="@involving.LastTime">
                                        <small class="text-muted">@TimePeriodHelper.Get(involving.LastTime)</small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center p-5">
                    <p class="lead text-muted">目前沒有 Involver 記錄。</p>
                </div>
            }
        </div>
    </div>
</div>
