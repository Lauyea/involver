@page "{id}"
@model Involver.Pages.Novels.DetailsModel

@{ 
    ViewData["Title"] = Model.Novel.Title;
    ViewData["From"] = Parameters.Novels;
    ViewData["FromId"] = Model.Novel.NovelID;
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<partial name="_Toasts" model="Model.Toasts" />

<div class="row">
    <div class="col-lg-9">
        @if (!string.IsNullOrEmpty(Model.Novel.ImageUrl))
        {
            <img src="@Model.Novel.ImageUrl"
                 asp-append-version="true"
                 alt="讀取失敗"
                 title="@Model.Novel.Title"
                 style="width: 100%; max-height: auto;border-radius:.5rem;">
            <p></p>
        }
        else
        {
            <img src="https://picsum.photos/600/300?grayscale&random=@Model.Novel.NovelID"
                 alt="讀取失敗"
                 title="主題圖片"
                 style="width: 100%; height: auto;border-radius:.5rem;" />
            <p></p>
        }
        <div class="card mb-4 mx-auto" style="margin-top:-4rem;width:90%;border-radius: 0.75rem;">
            <div class="row g-0">
                <div class="col-md-12">
                    <div class="card-body d-flex flex-column h-100">
                        <div class="d-flex justify-content-between align-items-start">
                            <h2 class="card-title text-break flex-grow-1">@Model.Novel.Title</h2>
                            <div class="d-flex justify-content-end flex-wrap">
                                <a asp-page="./Index" class="btn btn-sm btn-outline-secondary m-1" title="回到清單"><i class="fas fa-list"></i></a>
                                <a href="#CommentHead" class="btn btn-sm btn-outline-info m-1" title="評論"><i class="fas fa-comment"></i></a>
                                @if ((await AuthorizationService.AuthorizeAsync(User, Model.Novel, NovelOperations.Update)).Succeeded)
                                {
                                    <a asp-page="./Edit" asp-route-id="@Model.Novel.NovelID" class="btn btn-sm btn-outline-primary m-1" title="編輯"><i class="fas fa-edit"></i></a>
                                }
                                @if ((await AuthorizationService.AuthorizeAsync(User, Model.Novel, NovelOperations.Delete)).Succeeded)
                                {
                                    <a asp-page="./Delete" asp-route-id="@Model.Novel.NovelID" class="btn btn-sm btn-outline-danger m-1" title="刪除"><i class="fas fa-trash-alt"></i></a>
                                }
                            </div>
                        </div>

                        <p class="text-body-secondary">
                            作者：<a asp-area="Identity" asp-page="/Profile/Index" asp-route-id="@Model.Novel.ProfileID">@Model.Writer.UserName</a>
                        </p>

                        <p class="card-text ck-content">@Html.AntiXssRaw(Model.Novel.Introduction.Replace("\r\n", "<br />"))</p>

                        <div class="mt-auto">
                            <div class="mb-2">
                                @foreach (var tag in Model.Novel.NovelTags)
                                {
                                    <a asp-page="./Index" asp-route-currentFilter="@tag.Name" class="badge bg-info me-1">@tag.Name</a>
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2 text-body-secondary">
                                <small>更新於：@TimePeriodHelper.Get(Model.Novel.UpdateTime)</small>
                                <div>
                                    @if (Model.Novel.PrimeRead)
                                    {
                                        <span class="badge bg-warning text-dark" title="只有付費會員才能閱讀最新章節">
                                            <i class="fas fa-crown"></i> 付費限定
                                        </span>
                                    }
                                    @if (Model.Novel.End)
                                    {
                                        <span class="badge bg-success text-light">
                                            <i class="fas fa-flag-checkered"></i> 完結
                                        </span>
                                    }
                                    @if (Model.Novel.Block)
                                    {
                                        <span class="badge bg-danger text-light" title="封鎖的創作會在列表上隱藏，但可以分享連結用作私人房間。如要解封請提出申請">
                                            <i class="fas fa-lock"></i> 封鎖/ 隱藏
                                        </span>
                                    }
                                </div>

                            </div>

                            <div class="d-flex justify-content-around text-center border-top border-bottom py-2 mb-3">
                                <div>
                                    <div class="fw-bold">
                                        <a href="#" class="view-chart-trigger" data-type="novel" data-id="@Model.Novel.NovelID">@Html.DisplayFor(model => model.Novel.TotalViews)</a>
                                    </div>
                                    <small class="text-body-secondary">觀看數</small>
                                </div>
                                <div>
                                    <div class="fw-bold">
                                        <a asp-page="/Follows/Followers" asp-route-id="@Model.Novel.NovelID">@Model.Novel.Follows.Count()</a>
                                    </div>
                                    <small class="text-body-secondary">追蹤數</small>
                                </div>
                                <div>
                                    <div class="fw-bold">@Html.DisplayFor(model => model.Novel.TotalCoins)</div>
                                    <small class="text-body-secondary">總 InCoin</small>
                                </div>
                                <div>
                                    <div class="fw-bold">@Html.DisplayFor(model => model.Novel.MonthlyCoins)</div>
                                    <small class="text-body-secondary">本月 InCoin</small>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end align-items-center">
                                @if ((await AuthorizationService.AuthorizeAsync(User, Model.Novel, NovelOperations.Block)).Succeeded)
                                {
                                    <form style="display:inline;" method="post">
                                        <input type="hidden" name="id" value="@Model.Novel.NovelID" />
                                        <input type="hidden" name="block" value="@(Model.Novel.Block ? "false" : "true")" />
                                        <button type="submit" class="btn btn-sm @(Model.Novel.Block ? "btn-success" : "btn-danger") me-2">@(Model.Novel.Block ? "Unblock" : "Block")</button>
                                    </form>
                                }
                                @if (Model.UserId != null)
                                {
                                    <button type="button" onclick="FollowNovel(this, @Model.Novel.NovelID)" class="btn btn-sm @(Model.Followed ? "btn-secondary" : "btn-primary") me-2">
                                        @(Model.Followed ? "取消追蹤" : "追蹤創作")
                                    </button>
                                }
                                <a class="btn btn-sm btn-danger me-2" asp-page="/Involvings/InvolveNovel" asp-route-id="@Model.Novel.NovelID"><i class="fas fa-coins"></i> Involve</a>
                                <div class="dropdown">
                                    <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">Involvers</button>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item" asp-page="/Involvings/Involvers" asp-route-id="@Model.Novel.NovelID">最近</a>
                                        <a class="dropdown-item" asp-page="/Involvings/Involvers" asp-route-id="@Model.Novel.NovelID" asp-route-TimeSpan="Monthly">每月</a>
                                        <a class="dropdown-item" asp-page="/Involvings/Involvers" asp-route-id="@Model.Novel.NovelID" asp-route-TimeSpan="TotalTime">總共</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4" id="EpisodesHead">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">章節列表</h5>
                @if ((await AuthorizationService.AuthorizeAsync(User, Model.Novel, NovelOperations.Update)).Succeeded)
                {
                    <a asp-page="../Episodes/Create" asp-route-id="@Model.Novel.NovelID" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i> 新增章節</a>
                }
            </div>
            @* 這是章節列表的容器，第一頁的內容會由伺服器直接渲染在這裡 *@
            <div id="episodeListContainer" class="list-group list-group-flush">
                @await Component.InvokeAsync("EpisodeList", new { novelId = Model.Novel.NovelID, pageIndex = 1, pageSize = Parameters.PageSize })
            </div>

            <div class="card-footer d-flex justify-content-center">
                @* Container for the pagination controls *@
                <ul id="episodesPagination" class="pagination"></ul>
            </div>
        </div>

        <div class="card">
             <div class="card-header"><h5 class="mb-0">評論</h5></div>
             <div class="card-body">
                @await Component.InvokeAsync("CommentSection", new { from = Parameters.Novels, fromID = Model.Novel.NovelID })
             </div>
        </div>
    </div>
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header"><h5 class="mb-0">推薦創作</h5></div>
            <div class="card-body">
                <partial name="./PartialNovels" for="@Model.RecommendNovels" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/social-actions.js" asp-append-version="true"></script>
    <script src="~/js/utils.js" asp-append-version="true"></script>
    <script>
        // 取代 twbsPagination
        // TODO: 之後可能考慮寫到 site.js 裡共用
        // 使用 'DOMContentLoaded' 事件來確保在執行腳本前，頁面已完全載入
        document.addEventListener('DOMContentLoaded', function () {

            // 獲取需要操作的 DOM 元素
            const paginationContainer = document.getElementById('episodesPagination');
            const listContainer = document.getElementById('episodeListContainer');

            // 從 Model 獲取後端傳來的總頁數和 ID
            const totalPages = @Model.Episodes.TotalPages;
            const novelId = @Model.Novel.NovelID;

            // 如果總頁數小於或等於1，則不需要顯示分頁
            if (totalPages <= 1) {
                return; 
            }

            // 追蹤當前頁碼，預設為 1 (因為伺服器已渲染第一頁)
            let currentPage = 1;
            // 設定可見的頁碼按鈕數量 (同原設定)
            const visiblePages = 5;

            // --- 1. 載入章節資料的函式 (使用 Fetch API) ---
            function loadEpisodes(page) {
                //  (start)
                // 使用 fetch 進行非同步請求
                fetch(`?handler=Episodes&novelId=${novelId}&pageIndex=${page}`)
                    .then(response => {
                        // 檢查請求是否成功
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        // 將回應轉換為 HTML 文本
                        return response.text();
                    })
                    .then(data => {
                        // 將獲取的 HTML 替換掉列表容器的內容
                        listContainer.innerHTML = data; //
                        // 更新當前頁碼
                        currentPage = page;
                        // 重新渲染分頁按鈕 (來更新 'active' 狀態等)
                        renderPagination();
                    })
                    .catch(error => {
                        console.error('Error loading episodes:', error);
                        // 顯示錯誤訊息
                        alert('章節載入失敗，請稍後再試。');
                    });
                //  (end)
            }

            // --- 2. 渲染分頁按鈕的函式 ---
            function renderPagination() {
                // 清空舊的分頁按鈕
                paginationContainer.innerHTML = '';

                // --- 內部輔助函式：建立單個分頁項目 (<li><a>...</a></li>) ---
                // text: 按鈕上顯示的文字 (例如: '<', '1', '>>')
                // page: 該按鈕指向的頁碼
                // isDisabled: 是否禁用 (例如: '上一頁' 在第一頁時)
                // isActive: 是否為當前頁
                function createPageItem(page, text, isDisabled = false, isActive = false) {
                    const li = document.createElement('li');
                    li.className = 'page-item';
                    if (isDisabled) li.classList.add('disabled');
                    if (isActive) li.classList.add('active');

                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#'; // 避免頁面跳轉
                    a.dataset.page = page; // 將頁碼存在 data-page 屬性中
                    a.textContent = text;

                    if (isDisabled) {
                        a.setAttribute('tabindex', '-1');
                        a.setAttribute('aria-disabled', 'true');
                    }

                    li.appendChild(a);
                    return li;
                }

                // --- 計算要顯示的頁碼範圍 (核心邏輯) ---
                let startPage = Math.max(1, currentPage - Math.floor(visiblePages / 2));
                let endPage = Math.min(totalPages, startPage + visiblePages - 1);

                // 確保 'visiblePages' 數量：如果 endPage 已經到底
                if (endPage === totalPages) {
                    startPage = Math.max(1, totalPages - visiblePages + 1);
                }
                // 確保 'visiblePages' 數量：如果 startPage 已經到頂
                if (startPage === 1) {
                    endPage = Math.min(totalPages, visiblePages);
                }

                // --- 建立並添加按鈕 ---

                // "第一頁" (<<)
                paginationContainer.appendChild(createPageItem(1, '<<', currentPage === 1));

                // "上一頁" (<)
                paginationContainer.appendChild(createPageItem(currentPage - 1, '<', currentPage === 1));

                // 數字頁碼
                for (let i = startPage; i <= endPage; i++) {
                    paginationContainer.appendChild(createPageItem(i, i, false, i === currentPage));
                }

                // "下一頁" (>)
                paginationContainer.appendChild(createPageItem(currentPage + 1, '>', currentPage === totalPages));

                // "最後一頁" (>>)
                paginationContainer.appendChild(createPageItem(totalPages, '>>', currentPage === totalPages));
            }

            // --- 3. 綁定點擊事件 ---
            // 使用事件委派 (Event Delegation)，只在父容器上綁定一個監聽器
            paginationContainer.addEventListener('click', function (event) {
                // 防止 <a> 標籤的默認跳轉行為
                event.preventDefault();

                const target = event.target;

                // 確保點擊的是 <a> 標籤，並且它不處於 'disabled' 或 'active' 狀態
                if (target.tagName === 'A' && !target.parentElement.classList.contains('disabled') && !target.parentElement.classList.contains('active')) {
                    // 從 data-page 屬性獲取頁碼
                    const page = parseInt(target.dataset.page, 10);
                    if (!isNaN(page)) {
                        // 載入對應頁碼的章節
                        loadEpisodes(page);
                    }
                }
            });

            // --- 4. 初始渲染 ---
            // 頁面載入時，伺服器已經渲染了第一頁的內容
            // 我們只需要呼叫 renderPagination() 來產生第一頁的分頁控制按鈕
            renderPagination();
        });
    </script>
}