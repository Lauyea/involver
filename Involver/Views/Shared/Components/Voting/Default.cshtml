@model Involver.Views.Shared.Components.Voting.VotingViewModel

<div id="voting-app" data-episode-id="@Model.EpisodeId" data-is-professional="@Model.IsProfessional.ToString().ToLower()">
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">投票</h5>
                <div>
                    <a href="/Descriptions/Voting" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-info-circle"></i> 投票說明</a>
                    <button @@click="showCreateVotingModal" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i> 新增投票</button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div v-if="isLoading" class="text-center">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div v-else-if="error">
                <div class="alert alert-danger">{{ error }}</div>
            </div>
            <div v-else-if="votings.length === 0" class="text-center text-muted">
                <p>目前沒有進行中的投票。</p>
            </div>
            <div v-else>
                <div v-for="voting in votings" :key="voting.votingID" class="card mb-4 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-truncate" :title="voting.title">{{ voting.title }}</h5>
                        <span v-if="voting.policy === 0" class="badge badge-pill badge-success" title="這個投票的每張票價值有限">平等</span>
                        <span v-else-if="voting.policy === 1" class="badge badge-pill badge-warning" title="這個投票的每張票價值無限">自由</span>
                    </div>
                    <div class="card-body">
                        <div v-for="option in voting.options" :key="option.normalOptionID" class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-truncate" :title="option.content">{{ option.content }}</span>
                                <span v-if="voting.voted || voting.end" class="font-weight-bold">{{ getDisplayText(voting, option) }} ({{ getPercent(voting, option) }}%)</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div v-if="voting.voted || voting.end" class="progress-bar" role="progressbar" style="background-color: #e66532;" :style="{ width: getPercent(voting, option) + '%' }" :aria-valuenow="getPercent(voting, option)" aria-valuemin="0" aria-valuemax="100"></div>
                                <div v-else class="progress-bar bg-secondary" role="progressbar" style="width: 100%;"></div>
                            </div>
                        </div>
                        <form v-if="!voting.voted && !voting.end" @@submit.prevent="castVoteAsync(voting.votingID)" class="mt-3">
                            <div v-for="option in voting.options" :key="option.normalOptionID" class="form-check">
                                <input class="form-check-input" type="radio" :name="'voting-' + voting.votingID" :id="'option-' + option.normalOptionID" :value="option.normalOptionID" v-model.number="selectedOptions[voting.votingID]">
                                <label class="form-check-label" :for="'option-' + option.normalOptionID">
                                    {{ option.content }}
                                </label>
                            </div>
                        </form>
                        <div v-if="!voting.voted && !voting.end && voting.threshold > 0" class="text-right text-muted mt-2">
                            <small>票價：{{ voting.threshold }} In幣</small>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-muted">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="small">
                                <!-- Countdown/Limit display will go here -->
                            </div>
                            <button v-if="!voting.voted && !voting.end" @@click="castVoteAsync(voting.votingID)" :disabled="!selectedOptions[voting.votingID]" class="btn btn-sm btn-primary">
                                <i class="fas fa-vote-yea"></i> 投票
                            </button>
                            <span v-else class="badge badge-secondary">{{ voting.end ? '投票已結束' : '您已投票' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Voting Modal -->
    <div class="modal fade" id="createVotingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增投票</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <form @@submit.prevent="createVotingAsync">
                        <div class="form-group">
                            <label class="control-label">標題</label>
                            <textarea v-model="newVoting.title" class="form-control" rows="1" placeholder="在這裡寫些東西..."></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6" v-show="isProfessional">
                                <label class="control-label">策略</label>
                                <select v-model.number="newVoting.policy" class="form-control">
                                    <option value="0">平等</option>
                                    <option value="1">自由</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label class="control-label">限制</label>
                                <select v-model.number="newVoting.limit" class="form-control">
                                    <option value="0">限時</option>
                                    <option value="1">限量</option>
                                    <option value="2">限值</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label">票價</label>
                            <input v-model.number="newVoting.threshold" type="number" class="form-control" />
                        </div>

                        <div class="alert alert-warning mt-3" role="alert">
                            <strong>票價設定為零，則等於所有人都可投票</strong>
                        </div>

                        <div v-if="newVoting.limit === 0" class="form-group">
                            <label class="control-label">期限</label>
                            <input v-model="newVoting.deadLine" type="datetime-local" class="form-control" />
                        </div>
                        <div v-if="newVoting.limit === 1" class="form-group">
                            <label class="control-label">人數上限</label>
                            <input v-model.number="newVoting.numberLimit" type="number" class="form-control" />
                        </div>
                        <div v-if="newVoting.limit === 2" class="form-group">
                            <label class="control-label">總InCoins上限</label>
                            <input v-model.number="newVoting.coinLimit" type="number" class="form-control" />
                        </div>

                        <hr />

                        <h6>選項</h6>
                        <div v-for="(option, index) in newVoting.options" :key="index" class="form-group">
                            <label class="control-label">選項 {{ index + 1 }}</label>
                            <input v-model="option.content" class="form-control" placeholder="選項內容..." />
                        </div>

                        <div class="d-flex justify-content-start">
                            <button type="button" @@click="addOption" v-show="newVoting.options.length < 5" class="btn btn-sm btn-outline-secondary mr-2">增加選項</button>
                            <button type="button" type-button @@click="removeOption" v-show="newVoting.options.length > 2" class="btn btn-sm btn-outline-danger">減少選項</button>
                        </div>

                        <div class="alert alert-warning mt-3" role="alert">
                            <strong>一旦建立就無法編輯與刪除，請小心警慎地確認資料是否正確</strong>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                    <button type="button" @@click="createVotingAsync" class="btn btn-primary">建立</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/js/voting.js" type="module"></script>